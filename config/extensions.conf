; =============================================================================
; Asterisk Dialplan for Linphone SIP Integration
; Routes incoming calls to Stasis application for ExternalMedia handling
; =============================================================================

[general]
static=yes
writeprotect=no

; =============================================================================
; Context: from-linphone
; Handles incoming calls from Linphone.org (youngho@sip.linphone.org)
; =============================================================================
[from-linphone]
; Match any extension - incoming calls from Linphone
exten => _X.,1,NoOp(=== Incoming call from Linphone: ${CALLERID(all)} ===)
 same => n,NoOp(Called number: ${EXTEN})
 same => n,Answer()
 same => n,Wait(1)
 same => n,NoOp(Routing to Stasis app: linphone-handler)
 same => n,Stasis(linphone-handler)
 same => n,NoOp(Call ended, hanging up)
 same => n,Hangup()

; Catch-all for any other patterns (s extension for anonymous)
exten => s,1,NoOp(=== Incoming call to 's' extension ===)
 same => n,Answer()
 same => n,Wait(1)
 same => n,Stasis(linphone-handler)
 same => n,Hangup()

; Handle calls to 'youngho' directly
exten => youngho,1,NoOp(=== Direct call to youngho ===)
 same => n,Answer()
 same => n,Wait(1)
 same => n,Stasis(linphone-handler)
 same => n,Hangup()

; =============================================================================
; Context: from-internal
; For local SIP clients (agent02)
; =============================================================================
[from-internal]
exten => _X.,1,NoOp(=== Internal call: ${CALLERID(all)} ===)
 same => n,Answer()
 same => n,Stasis(linphone-handler)
 same => n,Hangup()

; =============================================================================
; Context: default (fallback)
; =============================================================================
[default]
exten => _X.,1,NoOp(Default context - unhandled call)
 same => n,Hangup()

; =============================================================================
; Context: from-anonymous
; Handles anonymous/unauthenticated SIP calls - reject with message
; =============================================================================
[from-anonymous]
exten => _X.,1,NoOp(=== Anonymous call attempt from ${CALLERID(all)} ===)
 same => n,Log(WARNING,Anonymous call rejected: ${CALLERID(num)} -> ${EXTEN})
 same => n,Set(TIMEOUT(absolute)=30)
 same => n,Answer()
 same => n,Wait(0.5)
 same => n,TryExec(Playback(ss-noservice))
 same => n,GotoIf($["${TRYEXEC_STATUS}" != "SUCCESS"]?hangup)
 same => n,Wait(1)
 same => n(hangup),Hangup(CALL_REJECTED)

; Handle 's' extension for anonymous
exten => s,1,Goto(_X.,1)
