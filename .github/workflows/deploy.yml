name: Deploy to EC2

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        env:
          AICC_WS_URL: ${{ secrets.AICC_WS_URL }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          LINPHONE_PASSWORD: ${{ secrets.LINPHONE_PASSWORD }}
          EC2_PUBLIC_IP: ${{ secrets.EC2_PUBLIC_IP }}
          VPC_CIDR: ${{ secrets.VPC_CIDR }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: AICC_WS_URL,DB_PASSWORD,LINPHONE_PASSWORD,EC2_PUBLIC_IP,VPC_CIDR
          script: |
            set -e
            echo "=== Starting deployment ==="

            # 1. Pull latest code
            cd ~/aws_asterisk
            git pull origin main

            # 1.5. Update .env file with WebSocket URL
            echo "=== Updating environment variables ==="
            if [ -n "$AICC_WS_URL" ]; then
              grep -q "^AICC_WS_URL=" python/aicc_pipeline/.env 2>/dev/null && \
                sed -i "s|^AICC_WS_URL=.*|AICC_WS_URL=$AICC_WS_URL|" python/aicc_pipeline/.env || \
                echo "AICC_WS_URL=$AICC_WS_URL" >> python/aicc_pipeline/.env
              echo "WebSocket URL updated: $AICC_WS_URL"
            fi

            # 2. Deploy Asterisk configurations
            echo "=== Deploying Asterisk configs ==="

            # Determine environment based on branch
            ENVIRONMENT="${ENVIRONMENT:-production}"
            if [ "$GITHUB_REF" = "refs/heads/develop" ] || [ "$GITHUB_REF" = "refs/heads/dev" ]; then
              ENVIRONMENT="development"
            fi
            echo "Deploying to environment: $ENVIRONMENT"

            # Select pjsip.conf template based on environment
            if [ "$ENVIRONMENT" = "production" ]; then
              PJSIP_TEMPLATE="config/pjsip.conf.prod.template"
            else
              PJSIP_TEMPLATE="config/pjsip.conf.dev.template"
            fi

            # Deploy pjsip.conf with environment variables
            if [ -n "$LINPHONE_PASSWORD" ] && [ -n "$EC2_PUBLIC_IP" ] && [ -n "$VPC_CIDR" ]; then
              export LINPHONE_PASSWORD EC2_PUBLIC_IP VPC_CIDR
              envsubst '${LINPHONE_PASSWORD} ${EC2_PUBLIC_IP} ${VPC_CIDR}' \
                < "$PJSIP_TEMPLATE" \
                | sudo tee /etc/asterisk/pjsip.conf > /dev/null
              echo "pjsip.conf deployed from $PJSIP_TEMPLATE"
            else
              echo "ERROR: Required environment variables not set for pjsip.conf"
              echo "Required: LINPHONE_PASSWORD, EC2_PUBLIC_IP, VPC_CIDR"
              exit 1
            fi

            # Deploy other configs
            sudo cp config/rtp.conf /etc/asterisk/rtp.conf
            sudo cp config/extensions.conf /etc/asterisk/extensions.conf
            sudo cp config/ari.conf /etc/asterisk/ari.conf
            sudo cp config/http.conf /etc/asterisk/http.conf
            sudo cp config/extconfig.conf /etc/asterisk/extconfig.conf
            sudo cp config/sorcery.conf /etc/asterisk/sorcery.conf

            # Deploy res_odbc.conf with DB password using envsubst
            if [ -n "$DB_PASSWORD" ]; then
              export DB_PASSWORD
              envsubst '${DB_PASSWORD}' < config/res_odbc.conf.template | sudo tee /etc/asterisk/res_odbc.conf > /dev/null
              echo "res_odbc.conf deployed with DB password"
            else
              sudo cp config/res_odbc.conf.template /etc/asterisk/res_odbc.conf
              echo "WARNING: DB_PASSWORD not set, using placeholder"
            fi

            sudo chown asterisk:asterisk /etc/asterisk/*.conf 2>/dev/null || sudo chown root:root /etc/asterisk/*.conf
            sudo chmod 640 /etc/asterisk/pjsip.conf
            sudo chmod 640 /etc/asterisk/res_odbc.conf

            # 3. Reload Asterisk
            echo "=== Reloading Asterisk ==="
            sudo asterisk -rx "module reload res_odbc.so" || true
            sudo asterisk -rx "core reload"
            sleep 2
            sudo asterisk -rx "pjsip reload"
            sudo asterisk -rx "dialplan reload"

            # 4. Install Node.js dependencies
            echo "=== Installing Stasis App dependencies ==="
            cd ~/aws_asterisk/stasis_app
            npm install --production

            # 5. Deploy and restart Stasis App
            echo "=== Deploying Stasis App service ==="
            sudo cp ~/aws_asterisk/stasis_app/stasis-app.service /etc/systemd/system/stasis-app.service
            sudo systemctl daemon-reload
            sudo systemctl enable stasis-app
            sudo systemctl restart stasis-app
            sleep 3
            sudo systemctl status stasis-app --no-pager || true

            # 6. Verify deployment
            echo "=== Verifying deployment ==="
            sudo asterisk -rx "odbc show" || true
            sudo asterisk -rx "pjsip show endpoints" | head -20
            sudo asterisk -rx "pjsip show registrations"
            sudo asterisk -rx "ari show apps"

            echo "=== Deployment completed! ==="
