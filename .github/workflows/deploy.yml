name: Deploy

on:
  push:
    branches: [main, dev]

env:
  AWS_REGION: ap-northeast-2
  SSM_DOCUMENT_NAME: DeployAICCPipeline

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.DEPLOY_AWS_KEY }}
          aws-secret-access-key: ${{ secrets.DEPLOY_AWS_SECRET }}
          aws-region: ${{ env.AWS_REGION }}

      # SSM Document 생성 또는 업데이트
      - name: Update SSM Document
        run: |
          echo "Checking SSM Document..."

          # 문서 존재 여부 확인
          if aws ssm describe-document --name "$SSM_DOCUMENT_NAME" &> /dev/null; then
            echo "Updating existing document..."

            # 현재 버전의 상태 확인
            STATUS=$(aws ssm describe-document --name "$SSM_DOCUMENT_NAME" --query 'Document.Status' --output text)

            if [ "$STATUS" = "Active" ]; then
              # 새 버전 생성
              aws ssm update-document \
                --name "$SSM_DOCUMENT_NAME" \
                --content file://.github/ssm-document.json \
                --document-version '$LATEST' || echo "Document unchanged"

              # 최신 버전을 기본으로 설정
              LATEST_VERSION=$(aws ssm describe-document --name "$SSM_DOCUMENT_NAME" --query 'Document.LatestVersion' --output text)
              aws ssm update-document-default-version \
                --name "$SSM_DOCUMENT_NAME" \
                --document-version "$LATEST_VERSION" || true
            fi
          else
            echo "Creating new document..."
            aws ssm create-document \
              --name "$SSM_DOCUMENT_NAME" \
              --content file://.github/ssm-document.json \
              --document-type "Command" \
              --document-format JSON
          fi

          echo "SSM Document ready"

      # EC2에 배포 명령 전송
      - name: Deploy to EC2
        run: |
          INSTANCE_ID="${{ secrets.DEPLOY_INSTANCE_ID }}"

          # Instance ID 확인
          if [ -z "$INSTANCE_ID" ]; then
            echo "ERROR: DEPLOY_INSTANCE_ID secret is not set"
            exit 1
          fi

          echo "Sending deployment command to $INSTANCE_ID..."

          COMMAND_ID=$(aws ssm send-command \
            --document-name "$SSM_DOCUMENT_NAME" \
            --instance-ids "$INSTANCE_ID" \
            --parameters "branch=[\"${{ github.ref_name }}\"]" \
            --timeout-seconds 600 \
            --query 'Command.CommandId' \
            --output text)

          echo "Command ID: $COMMAND_ID"
          echo "COMMAND_ID=$COMMAND_ID" >> $GITHUB_ENV
          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_ENV

      # 배포 완료 대기
      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to complete..."

          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")

            echo "Attempt $i/60: Status = $STATUS"

            case "$STATUS" in
              "Success")
                echo "Deployment successful!"
                exit 0
                ;;
              "Failed"|"Cancelled"|"TimedOut")
                echo "Deployment failed with status: $STATUS"
                aws ssm get-command-invocation \
                  --command-id "$COMMAND_ID" \
                  --instance-id "$INSTANCE_ID" \
                  --query 'StandardErrorContent' \
                  --output text || true
                exit 1
                ;;
              *)
                sleep 10
                ;;
            esac
          done

          echo "Deployment timed out"
          exit 1

      # 배포 결과 출력
      - name: Show deployment result
        if: always()
        run: |
          echo "========================================="
          echo "Deployment Output"
          echo "========================================="
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query 'StandardOutputContent' \
            --output text || echo "Could not retrieve output"
