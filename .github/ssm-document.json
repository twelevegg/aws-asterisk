{
  "schemaVersion": "2.2",
  "description": "Deploy AICC Pipeline from GitHub",
  "parameters": {
    "branch": {
      "type": "String",
      "default": "main",
      "description": "Git branch to deploy"
    }
  },
  "mainSteps": [
    {
      "action": "aws:runShellScript",
      "name": "deploy",
      "inputs": {
        "runCommand": [
          "#!/bin/bash",
          "set -e",
          "",
          "echo '========================================='",
          "echo 'AICC Pipeline Deployment'",
          "echo '========================================='",
          "",
          "PROJECT_DIR=/home/ubuntu/aws-asterisk",
          "",
          "# =========================================",
          "# 1. Docker 설치 확인 및 설치",
          "# =========================================",
          "if ! command -v docker &> /dev/null; then",
          "  echo 'Installing Docker...'",
          "  curl -fsSL https://get.docker.com | sh",
          "  sudo usermod -aG docker ubuntu",
          "  echo 'Docker installed successfully'",
          "else",
          "  echo 'Docker already installed'",
          "fi",
          "",
          "# Docker Compose 설치 확인 및 설치 (V2 플러그인)",
          "if ! docker compose version &> /dev/null; then",
          "  echo 'Installing Docker Compose plugin...'",
          "  sudo apt-get update",
          "  sudo apt-get install -y docker-compose-plugin",
          "  echo 'Docker Compose installed successfully'",
          "else",
          "  echo 'Docker Compose already installed'",
          "fi",
          "",
          "# Docker 서비스 시작",
          "sudo systemctl start docker || true",
          "sudo systemctl enable docker || true",
          "",
          "# =========================================",
          "# 2. 프로젝트 클론/업데이트",
          "# =========================================",
          "if [ ! -d \"$PROJECT_DIR\" ]; then",
          "  echo 'Cloning repository...'",
          "  cd /home/ubuntu",
          "  git clone https://github.com/twelevegg/aws-asterisk.git",
          "  if [ ! -d \"$PROJECT_DIR\" ]; then",
          "    echo 'ERROR: Clone failed'",
          "    exit 1",
          "  fi",
          "fi",
          "",
          "cd $PROJECT_DIR",
          "",
          "echo 'Fetching latest code...'",
          "git fetch origin",
          "git checkout {{ branch }}",
          "git pull origin {{ branch }}",
          "",
          "# =========================================",
          "# 3. 환경 설정 확인",
          "# =========================================",
          "",
          "# credentials 디렉토리 생성",
          "mkdir -p credentials",
          "",
          "# .env 파일 확인",
          "if [ ! -f .env ]; then",
          "  echo ''",
          "  echo '========================================='",
          "  echo 'WARNING: .env file not found!'",
          "  echo 'Creating from .env.example...'",
          "  echo 'Please configure .env file manually!'",
          "  echo '========================================='",
          "  echo ''",
          "  cp .env.example .env",
          "fi",
          "",
          "# GCP credentials 확인",
          "if [ ! -f credentials/gcp-credentials.json ]; then",
          "  echo ''",
          "  echo '========================================='",
          "  echo 'WARNING: GCP credentials not found!'",
          "  echo 'Please add credentials/gcp-credentials.json'",
          "  echo '========================================='",
          "  echo ''",
          "fi",
          "",
          "# =========================================",
          "# 4. Docker Compose 배포",
          "# =========================================",
          "echo 'Deploying with Docker Compose...'",
          "",
          "# 기존 컨테이너 정리",
          "sudo docker compose down --remove-orphans || true",
          "",
          "# 이미지 빌드 및 컨테이너 시작",
          "sudo docker compose up -d --build",
          "",
          "# 시작 대기",
          "echo 'Waiting for containers to start...'",
          "sleep 10",
          "",
          "# =========================================",
          "# 5. 상태 확인",
          "# =========================================",
          "echo ''",
          "echo '========================================='",
          "echo 'Deployment Status'",
          "echo '========================================='",
          "sudo docker compose ps",
          "",
          "# 헬스 체크",
          "UNHEALTHY=$(sudo docker compose ps | grep -E '(unhealthy|Exit)' || true)",
          "if [ -n \"$UNHEALTHY\" ]; then",
          "  echo ''",
          "  echo 'WARNING: Some containers may have issues:'",
          "  echo \"$UNHEALTHY\"",
          "  echo ''",
          "  echo 'Recent logs:'",
          "  sudo docker compose logs --tail=20",
          "fi",
          "",
          "echo ''",
          "echo 'Deployment complete!'"
        ]
      }
    }
  ]
}
